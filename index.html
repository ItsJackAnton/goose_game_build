<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Frenzy Miner</title>
    <link rel="shortcut icon" href="./TemplateData/favicon.ico" />
    <link rel="stylesheet" href="./TemplateData/style.css" />
    <script src="../TemplateData/noble-curves.js"></script>
  </head>
  <body class="dark">
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
    </div>
    <div id="unityLoader">
      <p>Loading...</p>
    </div>

    <div id="unity-fullscreen-button" style="display: none"></div>
    <script>
      var gameInstance = null;

      const hideFullScreenButton = "true";
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/goose_game_build.loader.js";
      const config = {
        dataUrl: buildUrl + "/goose_game_build.data.br",
        frameworkUrl: buildUrl + "/goose_game_build.framework.js.br",
        codeUrl: buildUrl + "/goose_game_build.wasm.br",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Frenzy Miner",
        productVersion: "0.1.0",

        // #if MEMORY_FILENAME
        //       memoryUrl: buildUrl + "/",
        // #endif
        // #if SYMBOLS_FILENAME
        //         symbolsUrl: buildUrl + "/",
        // #endif
      };

      const container = document.querySelector("#unity-container");
      const canvas = document.querySelector("#unity-canvas");
      // const loadingCover = document.querySelector("#loading-cover");
      const fullscreenButton = document.querySelector(
        "#unity-fullscreen-button"
      );
      // const loader = document.getElementById('unity-loader-circle-base');

      const unityLogo = document.getElementById("unity-title-img");
      const unityImage = document.getElementById("unity-logo-img");

      const playerSettingsUnityLogo = "";
      const playerSettingsUnityImage = "";

      if (
        playerSettingsUnityLogo !== "" &&
        playerSettingsUnityLogo.includes("{") == false
      ) {
        console.log(`Override Unity Logo \"${playerSettingsUnityLogo}\"`);
        unityLogo.src = playerSettingsUnityLogo;
      }
      if (
        playerSettingsUnityImage !== "" &&
        playerSettingsUnityImage.includes("{") == false
      ) {
        console.log(`Override Unity Image \"${playerSettingsUnityImage}\"`);

        unityImage.src = playerSettingsUnityImage;
      }

      const canFullscreen = (function () {
        for (const key of [
          "exitFullscreen",
          "webkitExitFullscreen",
          "webkitCancelFullScreen",
          "mozCancelFullScreen",
          "msExitFullscreen",
        ]) {
          if (key in document) {
            return true;
          }
        }
        return false;
      })();

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        config.devicePixelRatio = 1;
      }
      // #if BACKGROUND_FILENAME
      //     canvas.style.background = "url('" + buildUrl + "/') center / cover";
      // #endif
      // loadingCover.style.display = "block";

      const script = document.createElement("script");
      script.src = loaderUrl;

      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          // let x = Math.max(10, Math.ceil(progress * 100));
          // console.log("progress : " + x);
          // let rotation = "0";
          // if (x < 100) {
          //   rotation = "rotate(-" + (100 - x) + "deg)";
          // } else {
          //   rotation = "rotate(" + 50 + "deg)";
          // }
          // loader.style.transform = rotation;
        })
          .then((unityInstance) => {
            gameInstance = unityInstance;
            // loadingCover.style.display = "none";
            if (canFullscreen) {
              if (!hideFullScreenButton) {
                fullscreenButton.style.display = "block";
              }
              fullscreenButton.onclick = () => {
                unityInstance.SetFullscreen(1);
              };
            }

            unityInstance.Module.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            if (unityInstance.Module.audioContext.state === "suspended") {
              unityInstance.Module.audioContext.resume().then(() => {
                console.log("AudioContext is resumed.");
              });
            }
          })
          .catch((message) => {
            alert(message);
          });
      };

      document.body.appendChild(script);

      window.addEventListener(
        "message",
        function (e) {
          // Make sure to check the origin property for security reasons

          // if (
          //   e.origin !== "VALID URL ORIGIN" //Test Website (TODO: Remove)
          // ) {
          //   // Check origin for security
          //   console.error(
          //     "Source: Gaming HTML, Message: You are using a origin that is not valid, current origin: ",
          //     e.origin,
          //     "data: ",
          //     JSON.stringify(e.data)
          //   );
          //   return;
          // }

          console.log(
            "Source: Gaming HTML, Message: message received from origin: ",
            event.origin,
            "data: ",
            event.data
          );

          gameInstance.SendMessage(
            "BoomManager",
            "CreateIdentityWithJson",
            e.data
          );
        },
        false
      );

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(function () {
            console.log("Copied to clipboard: " + text);
          })
          .catch(function (err) {
            console.error("Could not copy text: ", err);
          });
      }
    </script>
  </body>
</html>
